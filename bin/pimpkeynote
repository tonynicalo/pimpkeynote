#!/usr/bin/env ruby

require 'fileutils'

# TODO: check if assets exists so that this is being ran in a keynote export

puts "What is the name of your slidedeck?"
title = STDIN.gets.chomp()

SLIDES_PATH = "./assets/images-1"
HTML_TOP = <<-EOF
<html>
<head>
  <meta name="auhtor" content="Coherence"/>
  <title>#{title}</title>
  <link rel="stylesheet" href="assets/css/normalize.css" type="text/css">
  <link rel="stylesheet" href="assets/css/site.css" type="text/css">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/1.4.3/jquery.scrollTo.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
  <script src="assets/js/jquery.scrollorama.js"></script>
  <script src="assets/js/jquery.scrolldeck.js"></script>
</head>
<body>
  <div id="header">
EOF

HTML_BOTTOM = <<-EOF
<script>
$(document).ready(function() {
  // Adjust height of slides
  $(".slide").height($(window).height());

  var deck = new $.scrolldeck({
    slides: ".slide",
    buttons: "#nav a",
    easing: 'easeInOutExpo'
  });

});
</script>
</body>
</html>
EOF

# Copy requried JS to project
ASSETS_PATH = File.expand_path("../../assets", __FILE__)
PIMPED_ASSETS_PATH = "./assets"

["js", "css"].each do |assets|
  #puts "Copying #{File.join(ASSETS_PATH, assets)} to #{File.join(PIMPED_ASSETS_PATH, assets)}"
  FileUtils.cp_r File.join(ASSETS_PATH, assets), File.join(PIMPED_ASSETS_PATH, assets)
end

# build pimped index page and link to slides
pimped_index = HTML_TOP

# Find slide images
slide_images = Dir.entries(SLIDES_PATH).reject {
  |f| [".", "..", "thumbnail.jpeg"].include?(f)
}

slides = {}
slide_images.each {|s|
  number = (s[/s(.*)\.b/,1] || 0).to_i + 1
  slides[number] = s
}
slides = slides.sort_by { |key, value| key }

slides.pop

# Build out nav
pimped_index += %{<div id="nav">}
slides.each do |slide|
  pimped_index += %{<a href="##{slide[0]}">#{slide[0]}</a>}
end

# close up nav and header
pimped_index += "</div></div>"

# build out image slides
slides.each do |slide|
  pimped_index += %{<div id="#{slide[0]}" class="slide">}
  pimped_index += %{<img src="#{File.join(SLIDES_PATH, slide[1])}">}
  pimped_index << "</div>"
end

File.write("./pimped-index.html", pimped_index + HTML_BOTTOM)
puts "Done. Open up pimped-index.html to check out the new presentation"
